const t={en:{models_title:"Models",download:"Download",download_quant8:"Download+INT8",chat_title:"Chat",quant_int8:"Quant INT8",quant_int4:"Quant INT4",generate:"Generate",del:"Delete",release:"Release",refresh:"Refresh",thinking:"Thinking...",continue:"Continue"},zh:{models_title:"模型",download:"下载",download_quant8:"下载+INT8量化",chat_title:"对话",quant_int8:"INT8量化",quant_int4:"INT4量化",generate:"生成",del:"删除",release:"释放",refresh:"刷新",thinking:"正在思考...",continue:"继续生成"}}
let lang="en"
const $=s=>document.querySelector(s)
function setLang(l){lang=l;document.querySelectorAll("[data-i18n]").forEach(e=>{const k=e.getAttribute("data-i18n");e.textContent=t[l][k]||k})}
async function sys(){const r=await fetch("/api/system/info");const j=await r.json();const acc=$("#accelerator");acc.innerHTML="";j.accelerators.forEach(a=>{const o=document.createElement("option");o.value=a.id;o.textContent=a.label;acc.appendChild(o)});const s=$("#sysinfo");s.textContent=`${j.os} ${j.os_version} · Python ${j.python} · Devices ${j.openvino_devices.join(", ")}`}
function updateAccelInfo(){const s=$("#sysinfo");const acc=$("#accelerator");const v=acc.value||"CPU";const tip=" · 推荐使用Intel NPU/GPU以获得最佳性能";const base=s.textContent.replace(/\s*·\s*当前加速器:[\s\S]*$/,'');s.textContent=`${base} · 当前加速器: ${v}${tip}`}
async function listModels(){const r=await fetch("/api/models/list");const j=await r.json();const c=$("#model_list");c.innerHTML="";const sel=$("#model_select");sel.innerHTML="";j.items.forEach(m=>{const d=document.createElement("div");d.className="item";const a=document.createElement("div");a.textContent=`${m.id} · ${(m.size_bytes/1024/1024).toFixed(2)} MB`;const b=document.createElement("div");const del=document.createElement("button");del.textContent=t[lang].del;del.onclick=async()=>{await fetch("/api/models/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:m.id})});await listModels()};b.appendChild(del);d.appendChild(a);d.appendChild(b);c.appendChild(d);const opt=document.createElement("option");opt.value=m.id;opt.textContent=m.id;sel.appendChild(opt)})}
async function startDownload(){const id=$("#model_id").value.trim();if(!id)return;const include=$("#include").value.trim();const exclude=$("#exclude").value.trim();const revision=$("#revision").value.trim();const body={model_id:id};if(include)body.include=include.split(/\s+/);if(exclude)body.exclude=exclude.split(/\s+/);if(revision)body.revision=revision;const r=await fetch("/api/models/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});const j=await r.json();pollTask(j.task_id,async()=>{await listModels();const expected=id.replace(/\//g,"__");const sel=$("#model_select");const found=Array.from(sel.options).some(o=>o.value===expected);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}})}
async function pollTask(taskId,onDone){const s=$("#download_status");s.innerHTML="";const wrap=document.createElement("div");wrap.className="progress";const bar=document.createElement("div");bar.className="bar";wrap.appendChild(bar);s.appendChild(wrap);const msg=document.createElement("div");s.appendChild(msg);let done=false;while(!done){const r=await fetch(`/api/tasks/${taskId}`);if(r.status!==200){msg.textContent="error";break}const j=await r.json();if(j.status==="running"&&(j.progress===undefined||j.progress<=1)){wrap.classList.add("ind")}else{wrap.classList.remove("ind");bar.style.width=(j.progress||0)+"%"}let friendlyMsg=j.message||"";if(friendlyMsg==="api_download"){friendlyMsg=(lang==="zh"?"正在通过 ModelScope API 下载...":"Downloading via ModelScope API...")}msg.textContent=friendlyMsg;if(j.status==="completed"){done=true;if(onDone)onDone()}if(j.status==="error"){done=true;const err=j.error||"error";if(/Calibration dataset is required/i.test(err)){showRefreshTip(lang==="zh"?"当前量化策略需要校准数据，建议选择 INT8/INT4 权重量化，或刷新页面查看列表":"Data-aware quantization requires calibration dataset. Please use INT8/INT4 or refresh.");msg.textContent=err}else{msg.textContent=err}}await new Promise(res=>setTimeout(res,1000))}}
async function downloadAndQuantizeInt8(){const id=$("#model_id").value.trim();if(!id)return;const include=$("#include").value.trim();const exclude=$("#exclude").value.trim();const revision=$("#revision").value.trim();const body={model_id:id};if(include)body.include=include.split(/\s+/);if(exclude)body.exclude=exclude.split(/\s+/);if(revision)body.revision=revision;const r=await fetch("/api/models/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});const j=await r.json();if(!j.task_id)return;await new Promise(res=>pollTask(j.task_id,res));const modelLocalId=id.replace(/\//g,"__");const rq=await fetch("/api/models/quantize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:modelLocalId,mode:"int8"})});const jq=await rq.json();if(jq.task_id){await new Promise(res=>pollTask(jq.task_id,res));await listModels();const sel=$("#model_select");const target=modelLocalId+"_quant_int8";const found=Array.from(sel.options).some(o=>o.value===target);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}else{sel.value=target}}}
async function quantize(mode){const sel=$("#model_select");const id=sel.value;if(!id)return;const r=await fetch("/api/models/quantize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,mode})});const j=await r.json();if(j.task_id)pollTask(j.task_id,async()=>{await listModels();const target=id+"_quant_"+mode;const found=Array.from($("#model_select").options).some(o=>o.value===target);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}})}
function showAlert(msg,docs,rec){const a=$("#alert");const m=$("#alert_msg");m.innerHTML=`${msg} <br> ${docs?`<a href='${docs}' target='_blank'>兼容性文档</a>`:""} ${rec&&rec.length?`· ${(rec||[]).join(', ')}`:""}`;a.style.display="flex"}
function showRefreshTip(text){const a=$("#alert");const m=$("#alert_msg");m.innerHTML=`${text} <button id='btn_refresh' style='margin-left:8px'>${t[lang].refresh}</button>`;a.style.display="flex";setTimeout(()=>{const br=document.querySelector('#btn_refresh');if(br)br.onclick=()=>location.reload()},0)}
let _firstLoadShown={}
function hideAlert(){const a=$("#alert");a.style.display="none"}
function showOverlay(){const ov=$("#loading_overlay");ov.classList.remove("hidden");setTimeout(()=>{$("#loading_tip").style.display="block"},5000)}
function hideOverlay(){const ov=$("#loading_overlay");ov.classList.add("hidden");$("#loading_tip").style.display="none"}
const chat=[]
function buildPromptFromChat(){const lines=[];for(let i=Math.max(0,chat.length-6);i<chat.length;i++){const x=chat[i];lines.push(`${x.role}: ${x.text||""}`)}lines.push(lang==="zh"?"请继续完整回答：":"Please continue the answer:");return lines.join("\n")}
function renderChat(filter){const wrap=$("#chat_msgs");if(!wrap)return;wrap.innerHTML="";const items=filter?chat.filter(x=>x.text.toLowerCase().includes(filter.toLowerCase())):chat;items.forEach(x=>{const b=document.createElement("div");b.className=`bubble ${x.role}${x.thinking?" thinking":""}`;if(x.thinking){const tdiv=document.createElement("div");tdiv.className="typing";for(let i=0;i<3;i++){const d=document.createElement("span");d.className="d";tdiv.appendChild(d)}b.appendChild(tdiv)}else{b.textContent=x.text}wrap.appendChild(b)})}
async function generate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const prompt=$("#prompt").value;if(!prompt)return;chat.push({role:"user",text:prompt});renderChat($("#chat_search").value||"");const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const config={max_new_tokens:parseInt($("#max_new").value,10),temperature:parseFloat($("#temperature").value),top_k:parseInt($("#top_k").value,10),top_p:parseFloat($("#top_p").value),repetition_penalty:parseFloat($("#rep_penalty").value),perf_mode:$("#perf_mode")?$("#perf_mode").value:undefined,npu_streams:$("#npu_streams")?parseInt($("#npu_streams").value,10):undefined};const key=`${device}:${id}`;let needOverlay=!_firstLoadShown[key];try{const r0=await fetch(`/api/models/is_loaded?model_id=${encodeURIComponent(id)}&device=${encodeURIComponent(device)}`);if(r0.status===200){const j0=await r0.json();if(j0.loaded===true)needOverlay=false}}catch(_){}let overlayShown=false;if(needOverlay){showOverlay();overlayShown=true}let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device,prompt,config})});j=await r.json();}catch(e){j={error:String(e)}}if(overlayShown)hideOverlay();if(j.friendly&&j.error_code==="incompatible_acceleration"){showAlert(j.message,j.docs_link,j.recommended);const idx=chat.indexOf(thinking);if(idx>-1){chat.splice(idx,1)}renderChat($("#chat_search").value||"");return}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"");if(j.output){_firstLoadShown[key]=true}}
async function continueGenerate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const prompt=buildPromptFromChat();const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const config={max_new_tokens:parseInt($("#max_new").value,10),temperature:parseFloat($("#temperature").value),top_k:parseInt($("#top_k").value,10),top_p:parseFloat($("#top_p").value),repetition_penalty:parseFloat($("#rep_penalty").value),perf_mode:$("#perf_mode")?$("#perf_mode").value:undefined,npu_streams:$("#npu_streams")?parseInt($("#npu_streams").value,10):undefined};let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device,prompt,config})});j=await r.json();}catch(e){j={error:String(e)}}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"")}
async function pollPerf(){try{const r=await fetch("/api/perf");if(r.status!==200)return;const j=await r.json();const el=$("#perf");const a=j.avg||{};const last=j.last||{};let warn="";if(j.warn==="npu_slower_than_cpu")warn="⚠️ NPU性能低于CPU，建议切换加速模式";el.textContent=`Latency avg(ms): CPU=${a.CPU||"-"} GPU=${a.GPU||"-"} NPU=${a.NPU||"-"} NVIDIA=${a.NVIDIA||"-"} · last ${last.device||""}=${last.latency_ms||"-"} ${warn}`;}catch(e){}}
function init(){setLang(lang);$("#lang").onchange=e=>setLang(e.target.value);$("#btn_download").onclick=startDownload;$("#btn_dl_quant_int8").onclick=downloadAndQuantizeInt8;$("#btn_quant_int8").onclick=()=>quantize("int8");$("#btn_quant_int4").onclick=()=>quantize("int4");const br=$("#btn_release");if(br)br.onclick=async()=>{const id=$("#model_select").value;if(!id)return;await fetch("/api/models/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id})});showAlert(lang==="zh"?"已释放模型，现在可以删除或切换设备":"Model released. You can delete or switch device.","#",[])};const brg=$("#btn_release_global");if(brg)brg.onclick=async()=>{const id=$("#model_select").value;if(!id)return;await fetch("/api/models/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id})});showAlert(lang==="zh"?"已释放模型，现在可以删除或切换设备":"Model released. You can delete or switch device.","#",[])};$("#btn_generate").onclick=generate;const bc=$("#btn_continue");if(bc)bc.onclick=continueGenerate;const cs=$("#chat_search");if(cs)cs.oninput=e=>renderChat(e.target.value||"");const wiz=$("#btn_wizard");if(wiz)wiz.onclick=async()=>{const mod=await import('/static/ui.js');mod.openWizard({acc:$("#accelerator").value,perf:$("#perf_mode").value,streams:parseInt($("#npu_streams").value,10)||1},(res)=>{if(res){$("#perf_mode").value=res.perf;$("#npu_streams").value=res.streams}})};showStartup();setInterval(ping,2000);sys().then(async()=>{const acc=$("#accelerator");if(acc.options.length){const opts=Array.from(acc.options).map(o=>o.value);acc.value=opts.find(v=>v==="MULTI:NPU,GPU")||opts.find(v=>v==="NPU")||opts.find(v=>v==="MULTI:NPU,CPU")||opts.find(v=>v==="MULTI:NPU,GPU,CPU")||opts.find(v=>v==="GPU")||opts.find(v=>v==="CPU")||Array.from(acc.options)[0].value}updateAccelInfo();acc.onchange=updateAccelInfo;await listModels();const sel=$("#model_select");if(sel.value){await fetch("/api/infer/preload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:sel.value,device:acc.value,config:{perf_mode:$("#perf_mode")?$("#perf_mode").value:undefined,npu_streams:$("#npu_streams")?parseInt($("#npu_streams").value,10):undefined}})})}});setInterval(pollPerf,3000)}
document.addEventListener("DOMContentLoaded",init)
document.addEventListener("DOMContentLoaded",async()=>{try{const mod=await import('/static/ui.js');mod.attachTooltips()}catch(e){}})
function showStartup(){const b=$("#startup_banner");if(b)b.classList.remove("hidden")}function hideStartup(){const b=$("#startup_banner");if(b)b.classList.add("hidden")}async function ping(){try{const p=Promise.race([fetch("/api/system/info"),new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),1500))]);const r=await p;if(r&&r.status===200){hideStartup();return true}else{showStartup();return false}}catch(e){showStartup();return false}}